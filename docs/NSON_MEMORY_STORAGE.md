# NSON å†…å­˜å­˜å‚¨æ–¹æ¡ˆ

## ğŸ¯ æ ¸å¿ƒæ€æƒ³

**æ¿€è¿›æ–¹æ¡ˆ**ï¼šå°†é…ç½®æ•°æ®å®Œå…¨æ”¾åœ¨å†…å­˜ï¼Œç”¨ NSON åºåˆ—åŒ–æŒä¹…åŒ–ï¼Œå½»åº•ç®€åŒ–æ¶æ„ã€‚

## ğŸ“¦ æ•°æ®åˆ†ç±»

### 1. é…ç½®æ•°æ®ï¼ˆConfig Dataï¼‰- å†…å­˜ + NSON
- **Node**: èŠ‚ç‚¹å…ƒæ•°æ®
- **Wire**: é€šä¿¡æ€»çº¿é…ç½®  
- **Pin**: æ•°æ®ç‚¹é…ç½®

**ç‰¹ç‚¹**ï¼š
- ç›¸å¯¹é™æ€ï¼Œä¿®æ”¹é¢‘ç‡ä½
- éœ€è¦æŒä¹…åŒ–
- ç»“æ„åŒ–æ•°æ®

### 2. å®æ—¶æ•°æ®ï¼ˆRuntime Dataï¼‰- Badger
- **PinValue**: Pin å½“å‰è¯»å–å€¼
- **PinWrite**: Pin å†™å…¥å€¼
- **Sync**: åŒæ­¥æ—¶é—´æˆ³

**ç‰¹ç‚¹**ï¼š
- é«˜é¢‘æ›´æ–°
- é”®å€¼å­˜å‚¨å³å¯
- ä¿æŒç°æœ‰ Badger æ–¹æ¡ˆ

## ğŸ—ï¸ æ¶æ„å¯¹æ¯”

### ç°æœ‰æ¶æ„ï¼ˆå¤æ‚ï¼‰
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Core/Edge     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Service Layer  â”‚
â”‚       â†“â†“â†“       â”‚
â”‚  Bun ORM (SQL)  â”‚
â”‚       â†“â†“â†“       â”‚
â”‚ SQLite (CGO)    â”‚
â”‚       â†“â†“â†“       â”‚
â”‚    æ–‡ä»¶ç³»ç»Ÿ      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é—®é¢˜ï¼š
âŒ éœ€è¦ CGOï¼ˆè·¨å¹³å°ç¼–è¯‘å›°éš¾ï¼‰
âŒ SQL æŸ¥è¯¢å¼€é”€
âŒ ORM æ˜ å°„å¼€é”€
âŒ å¤æ‚çš„åŒæ­¥é€»è¾‘
```

### æ–°æ¶æ„ï¼ˆç®€åŒ–ï¼‰
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Core ç«¯                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å†…å­˜ Map (Node/Wire/Pin)        â”‚
â”‚       â†“                           â”‚
â”‚  NSON åºåˆ—åŒ–                      â”‚
â”‚       â†“                           â”‚
â”‚  Badger (çº¯ Go)                  â”‚
â”‚    - key: node:{id}              â”‚
â”‚    - value: NSON bytes           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Edge ç«¯                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å†…å­˜ Map (Node/Wire/Pin)        â”‚
â”‚       â†“                           â”‚
â”‚  NSON æ–‡ä»¶ (config.nson)         â”‚
â”‚  (æ— éœ€æ•°æ®åº“ï¼)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¼˜åŠ¿ï¼š
âœ… æ—  CGO ä¾èµ–
âœ… æŸ¥è¯¢é€Ÿåº¦æå¿«ï¼ˆçº³ç§’çº§å†…å­˜æŸ¥è¯¢ï¼‰
âœ… åŒæ­¥ç®€å•ï¼ˆä¼ è¾“ NSON æ–‡ä»¶ï¼‰
âœ… æ˜“äºéƒ¨ç½²ï¼ˆEdge ä¸€ä¸ªäºŒè¿›åˆ¶+ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼‰
âœ… å¯è¯»å¯ç¼–è¾‘ï¼ˆNSON å¯è½¬ JSONï¼‰
```

## ğŸ”„ æ•°æ®åŒæ­¥

### Edge â†’ Coreï¼ˆPushï¼‰
```go
// Edge ç«¯
nsonData := edgeStorage.ExportToBytes()
client.PushConfig(nodeID, nsonData)

// Core ç«¯
coreStorage.PushNodeConfig(nsonData)
// ä¸€æ¬¡æ€§æ›¿æ¢æ•´ä¸ªèŠ‚ç‚¹é…ç½®
```

### Core â†’ Edgeï¼ˆPullï¼‰
```go
// Edge ç«¯
nsonData := client.PullConfig(nodeID)
edgeStorage.LoadFromBytes(nsonData)
// ä¸€æ¬¡æ€§æ›¿æ¢æœ¬åœ°é…ç½®
```

**ä¼˜åŠ¿**ï¼š
- ğŸ¯ åŸå­æ€§æ›´æ–°ï¼Œä¸ä¼šå‡ºç°éƒ¨åˆ†åŒæ­¥
- ğŸ“¦ ä¼ è¾“æ•°æ®å°‘ï¼ˆNSON äºŒè¿›åˆ¶æ ¼å¼ç´§å‡‘ï¼‰
- ğŸš€ æ— éœ€å¤æ‚çš„å¢é‡åŒæ­¥é€»è¾‘

## ğŸ” Secret ç®¡ç†

### Core ç«¯
```go
// Secret å•ç‹¬å­˜å‚¨åœ¨ Badgerï¼Œæ”¯æŒä¿®æ”¹
badger: secret:{node_id} â†’ secret_string

// ä¿®æ”¹ API
UpdateSecret(nodeID, newSecret)
```

### Edge ç«¯
```go
// æ–¹æ¡ˆ 1: é…ç½®æ–‡ä»¶
edge_config.nson:
{
  "secret": "generated_secret",
  ...
}

// æ–¹æ¡ˆ 2: ç¯å¢ƒå˜é‡
export EDGE_SECRET="xxx"

// æ–¹æ¡ˆ 3: ç­¾åç”Ÿæˆï¼ˆæ¨èï¼‰
secret = sign(node_id, private_key)
// ä½¿ç”¨éå¯¹ç§°åŠ å¯†ï¼ŒCore éªŒè¯
```

## ğŸ“ NSON æ–‡ä»¶ç¤ºä¾‹

```json
{
  "version": "1.0",
  "node": {
    "id": "node_abc123",
    "name": "EdgeDevice01",
    "status": 1
  },
  "wires": [
    {
      "id": "wire_001",
      "node_id": "node_abc123",
      "name": "modbus_rtu",
      "type": "modbus_rtu",
      "tags": "serial,industrial",
      "clusters": ""
    },
    {
      "id": "wire_002",
      "node_id": "node_abc123",
      "name": "gpio",
      "type": "gpio",
      "tags": "digital,io"
    }
  ],
  "pins": [
    {
      "id": "pin_001",
      "node_id": "node_abc123",
      "wire_id": "wire_001",
      "name": "temp_sensor",
      "addr": "40001",
      "type": "float32",
      "rw": 1,
      "tags": "temperature"
    },
    {
      "id": "pin_002",
      "node_id": "node_abc123",
      "wire_id": "wire_002",
      "name": "led_1",
      "addr": "GPIO17",
      "type": "bool",
      "rw": 2,
      "tags": "output"
    }
  ],
  "secret": "auto_generated_secret"
}
```

## ğŸ› ï¸ å·¥å…·é“¾

### 1. é…ç½®ç”Ÿæˆå™¨
```bash
# ç”Ÿæˆé»˜è®¤é…ç½®
beacon-config-gen -o edge_config.nson \
  --node-name "MyDevice" \
  --secret "auto"

# ä»æ¨¡æ¿ç”Ÿæˆ
beacon-config-gen -t template.yaml -o edge_config.nson

# éªŒè¯é…ç½®
beacon-config-validate edge_config.nson
```

### 2. é…ç½®ç¼–è¾‘å™¨
```bash
# NSON â†” JSON è½¬æ¢ï¼ˆä¾¿äºäººå·¥ç¼–è¾‘ï¼‰
beacon-config-convert edge_config.nson -o config.json
vi config.json
beacon-config-convert config.json -o edge_config.nson

# æ·»åŠ  Wire
beacon-config-edit edge_config.nson add-wire \
  --name modbus_tcp --type modbus_tcp

# æ·»åŠ  Pin
beacon-config-edit edge_config.nson add-pin \
  --wire modbus_tcp --name sensor_1 --addr 40001
```

### 3. ç­¾åå·¥å…·
```bash
# ç”Ÿæˆå¯†é’¥å¯¹
beacon-keygen -o edge_key.pem

# ç­¾åé…ç½®æ–‡ä»¶
beacon-sign edge_config.nson -k edge_key.pem

# éªŒè¯ç­¾å
beacon-verify edge_config.nson -k edge_key.pub
```

## ğŸš€ æ€§èƒ½å¯¹æ¯”

### æŸ¥è¯¢æ€§èƒ½
```
SQL æŸ¥è¯¢:        ~100-500 Î¼s (å¾®ç§’)
å†…å­˜ Map æŸ¥è¯¢:   ~50-200 ns (çº³ç§’)
æ€§èƒ½æå‡:        1000-10000 å€
```

### å¯åŠ¨é€Ÿåº¦
```
SQLite:          åŠ è½½ + å»ºç«‹è¿æ¥ + æŸ¥è¯¢
NSON:            æ–‡ä»¶è¯»å– + ååºåˆ—åŒ–
Edge å¯åŠ¨:       ~10-50 ms (1000 ä¸ª Pin)
```

### åŒæ­¥æ•ˆç‡
```
ç°æœ‰æ–¹æ¡ˆ:        å¢é‡åŒæ­¥ï¼Œå¤šæ¬¡ gRPC è°ƒç”¨
æ–°æ–¹æ¡ˆ:          ä¸€æ¬¡ä¼ è¾“å®Œæ•´é…ç½®
æ•°æ®é‡:          ~1-10 KB (å…¸å‹é…ç½®)
```

## âš™ï¸ å®ç°æ­¥éª¤

### Phase 1: åŸºç¡€è®¾æ–½
- [x] è®¾è®¡æ–‡æ¡£
- [ ] å®ç° Core ç«¯å†…å­˜å­˜å‚¨å±‚
- [ ] å®ç° Edge ç«¯å†…å­˜å­˜å‚¨å±‚
- [ ] NSON åºåˆ—åŒ–/ååºåˆ—åŒ–æµ‹è¯•

### Phase 2: è¿ç§» API
- [ ] ä¿ç•™åŸæœ‰ SQL æŸ¥è¯¢ä½œä¸º fallback
- [ ] æ–° API ä½¿ç”¨å†…å­˜å­˜å‚¨
- [ ] A/B æµ‹è¯•

### Phase 3: åŒæ­¥ç®€åŒ–
- [ ] å®ç° PushConfig / PullConfig API
- [ ] ç§»é™¤æ—§çš„å¢é‡åŒæ­¥é€»è¾‘
- [ ] å‹åŠ›æµ‹è¯•

### Phase 4: å·¥å…·å’Œæ–‡æ¡£
- [ ] é…ç½®ç”Ÿæˆå·¥å…·
- [ ] é…ç½®ç¼–è¾‘å·¥å…·
- [ ] è¿ç§»å·¥å…·ï¼ˆSQL â†’ NSONï¼‰
- [ ] ç”¨æˆ·æ–‡æ¡£

### Phase 5: å®Œå…¨åˆ‡æ¢
- [ ] ç§»é™¤ Bun ORM ä¾èµ–
- [ ] ç§»é™¤ SQLite ä¾èµ–
- [ ] æ€§èƒ½æµ‹è¯•å’Œä¼˜åŒ–

## ğŸ é¢å¤–å¥½å¤„

1. **ç‰ˆæœ¬æ§åˆ¶å‹å¥½**
   - NSON å¯è½¬ JSONï¼Œå¯ä»¥ç”¨ git ç®¡ç†é…ç½®
   - å¯ä»¥ diff ä¸åŒç‰ˆæœ¬

2. **é…ç½®å³ä»£ç **
   - é…ç½®æ–‡ä»¶å¯ä»¥æ¨¡æ¿åŒ–
   - å¯ä»¥ç”¨è„šæœ¬ç”Ÿæˆé…ç½®

3. **è°ƒè¯•å‹å¥½**
   - ç›´æ¥æŸ¥çœ‹ NSON/JSON æ–‡ä»¶
   - ä¸éœ€è¦ SQL å·¥å…·

4. **éƒ¨ç½²ç®€å•**
   - Edge: ä¸€ä¸ªäºŒè¿›åˆ¶ + ä¸€ä¸ªé…ç½®æ–‡ä»¶
   - æ— éœ€åˆå§‹åŒ–æ•°æ®åº“

5. **è·¨å¹³å°æ— é˜»ç¢**
   - æ—  CGOï¼Œç¼–è¯‘ç®€å•
   - `GOOS=linux GOARCH=arm go build`

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. å†…å­˜å ç”¨
- 1000 ä¸ª Pin â‰ˆ 1-2 MB å†…å­˜ï¼ˆå¯æ¥å—ï¼‰
- 10000 ä¸ª Pin â‰ˆ 10-20 MBï¼ˆä¾ç„¶å¾ˆå°ï¼‰

### 2. å¹¶å‘å®‰å…¨
- ä½¿ç”¨ `sync.RWMutex` ä¿æŠ¤
- è¯»å¤šå†™å°‘ï¼Œæ€§èƒ½å¾ˆå¥½

### 3. æ•°æ®ä¸€è‡´æ€§
- é…ç½®æ›´æ–°ç«‹å³æŒä¹…åŒ–
- Badger æä¾› ACID ä¿è¯

### 4. è¿ç§»é£é™©
- æä¾› SQL â†’ NSON è¿ç§»å·¥å…·
- ä¿æŒ API å…¼å®¹æ€§
- åˆ†é˜¶æ®µè¿ç§»

## ğŸ¯ ç»“è®º

è¿™æ˜¯ä¸€ä¸ª**æ¿€è¿›ä½†é«˜æ•ˆ**çš„æ–¹æ¡ˆï¼š

âœ… **å»æ‰ CGO** - è§£å†³è·¨å¹³å°ç¼–è¯‘é—®é¢˜  
âœ… **æè‡´æ€§èƒ½** - å†…å­˜æŸ¥è¯¢ï¼Œçº³ç§’çº§å“åº”  
âœ… **ç®€åŒ–æ¶æ„** - å»æ‰ ORM å’Œ SQL å±‚  
âœ… **ç®€åŒ–åŒæ­¥** - ä¼ è¾“ NSON æ–‡ä»¶å³å¯  
âœ… **æ˜“äºéƒ¨ç½²** - Edge æ— éœ€æ•°æ®åº“  
âœ… **æ˜“äºç»´æŠ¤** - é…ç½®æ–‡ä»¶å¯è¯»å¯ç¼–è¾‘  

**æ¨èé‡‡ç”¨ï¼** ğŸš€
