# Beacon æ¶æ„è®¾è®¡æ–‡æ¡£

## ğŸ“‹ ç›®å½•

1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [æ ¸å¿ƒæ¦‚å¿µ](#æ ¸å¿ƒæ¦‚å¿µ)
3. [ç³»ç»Ÿæ¶æ„](#ç³»ç»Ÿæ¶æ„)
4. [æ•°æ®æ¨¡å‹](#æ•°æ®æ¨¡å‹)
5. [å­˜å‚¨æ¶æ„](#å­˜å‚¨æ¶æ„)
6. [é€šä¿¡åè®®](#é€šä¿¡åè®®)
7. [åŒæ­¥æœºåˆ¶](#åŒæ­¥æœºåˆ¶)
8. [è®¾å¤‡æŠ½è±¡](#è®¾å¤‡æŠ½è±¡)

## æ¦‚è¿°

Beacon æ˜¯ä¸€ä¸ªä¸º IoT åœºæ™¯è®¾è®¡çš„é«˜æ€§èƒ½å¼€å‘æ¡†æ¶ï¼Œé‡‡ç”¨ Core-Edge åˆ†å¸ƒå¼æ¶æ„ã€‚

### è®¾è®¡ç›®æ ‡

- **é«˜æ€§èƒ½**: å†…å­˜å­˜å‚¨ + NSON åºåˆ—åŒ–ï¼Œå¾®ç§’çº§å“åº”
- **æ˜“éƒ¨ç½²**: çº¯ Go å®ç°ï¼Œæ—  CGO ä¾èµ–ï¼Œå•ä¸€äºŒè¿›åˆ¶æ–‡ä»¶
- **å¯æ‰©å±•**: çµæ´»çš„ Wire/Pin æ¨¡å‹ï¼Œæ”¯æŒå„ç§ IoT è®¾å¤‡
- **ä½èµ„æº**: Edge ç«¯å¯è¿è¡Œåœ¨èµ„æºå—é™çš„åµŒå…¥å¼è®¾å¤‡

### æŠ€æœ¯æ ˆ

- **è¯­è¨€**: Go 1.24+
- **åºåˆ—åŒ–**: NSON (é«˜æ•ˆäºŒè¿›åˆ¶æ ¼å¼)
- **å­˜å‚¨**: Badger (åµŒå…¥å¼ KV æ•°æ®åº“)
- **é€šä¿¡**: gRPC + Protocol Buffers
- **æ—¥å¿—**: Zap (é«˜æ€§èƒ½ç»“æ„åŒ–æ—¥å¿—)

## æ ¸å¿ƒæ¦‚å¿µ

### 1. Node (èŠ‚ç‚¹)

ä»£è¡¨ä¸€ä¸ª IoT è®¾å¤‡æˆ–è¾¹ç¼˜èŠ‚ç‚¹ã€‚

```go
type Node struct {
    ID      string    // å”¯ä¸€æ ‡è¯†
    Name    string    // åç§°
    Status  int32     // çŠ¶æ€: 0=ç¦»çº¿, 1=åœ¨çº¿
    Updated time.Time // æ›´æ–°æ—¶é—´
    Wires   []Wire    // åŒ…å«çš„ Wire åˆ—è¡¨
}
```

**ç‰¹ç‚¹**:
- Core ç«¯å¯ç®¡ç†å¤šä¸ª Node
- Edge ç«¯é€šå¸¸åªæœ‰ä¸€ä¸ª Node
- Node æ˜¯é…ç½®æ•°æ®çš„é¡¶å±‚å®¹å™¨

### 2. Wire (é€šé“/ç«¯ç‚¹)

ä»£è¡¨è®¾å¤‡çš„ä¸€ä¸ªåŠŸèƒ½ç«¯ç‚¹æˆ–é€šä¿¡é€šé“ã€‚

```go
type Wire struct {
    ID       string   // å”¯ä¸€æ ‡è¯†
    Name     string   // åç§° (åœ¨ Node å†…å”¯ä¸€)
    Type     string   // ç±»å‹æ ‡è¯†
    Tags     []string // æ ‡ç­¾
    Clusters []string // åŒ…å«çš„ Cluster åˆ—è¡¨
    Pins     []Pin    // åŒ…å«çš„ Pin åˆ—è¡¨
}
```

**ç¤ºä¾‹**:
- Modbus RTU é€šé“
- GPIO ç«¯å£ç»„
- MQTT è¿æ¥
- HTTP API ç«¯ç‚¹

### 3. Pin (æ•°æ®ç‚¹)

ä»£è¡¨å…·ä½“çš„æ•°æ®ç‚¹æˆ–å±æ€§ã€‚

```go
type Pin struct {
    ID   string   // å”¯ä¸€æ ‡è¯†
    Name string   // åç§° (åœ¨ Wire å†…å”¯ä¸€)
    Addr string   // åœ°å€ (å¦‚ Modbus åœ°å€)
    Type uint32   // æ•°æ®ç±»å‹ (NSON DataType)
    Rw   int32    // è¯»å†™å±æ€§: 0=åªè¯», 1=è¯»å†™, 2=åªå†™
    Tags []string // æ ‡ç­¾
}
```

**æ•°æ®ç±»å‹**:
- Bool, I8, I16, I32, I64
- U8, U16, U32, U64
- F32, F64
- String, Binary

### 4. Cluster (é›†ç¾¤/æ¨¡æ¿)

Pin çš„é€»è¾‘åˆ†ç»„ï¼Œç”¨äºæ ‡å‡†åŒ–è®¾å¤‡å®šä¹‰ã€‚

```go
type Cluster struct {
    ID          ClusterID     // é›†ç¾¤ ID
    Name        string        // åç§°
    Description string        // æè¿°
    Pins        []PinTemplate // Pin æ¨¡æ¿åˆ—è¡¨
}
```

**é¢„å®šä¹‰ Cluster**:
- `OnOff` - å¼€å…³æ§åˆ¶
- `LevelControl` - äº®åº¦/çº§åˆ«æ§åˆ¶
- `ColorControl` - é¢œè‰²æ§åˆ¶ (HSV)
- `TemperatureMeasurement` - æ¸©åº¦æµ‹é‡
- `HumidityMeasurement` - æ¹¿åº¦æµ‹é‡
- `BasicInformation` - è®¾å¤‡åŸºæœ¬ä¿¡æ¯

## ç³»ç»Ÿæ¶æ„

### æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Core ç«¯                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ gRPC Server  â”‚  â”‚ Node Service â”‚  â”‚  TCP Service    â”‚   â”‚
â”‚  â”‚ (CoreService)â”‚  â”‚ (NodeService)â”‚  â”‚ (TcpNodeService)â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚                  â”‚                    â”‚            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              CoreService (ä¸šåŠ¡é€»è¾‘)                    â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚ Node    â”‚ â”‚ Wire    â”‚ â”‚ Pin      â”‚ â”‚ PinValue   â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ Service â”‚ â”‚ Service â”‚ â”‚ Service  â”‚ â”‚ Service    â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚               Storage (å†…å­˜ + Badger)                  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚  å†…å­˜ Map:  nodes, wires, pins (å¿«é€ŸæŸ¥è¯¢)        â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  æ‡’ç´¢å¼•:    æŒ‰éœ€æ„å»ºï¼Œè‡ªåŠ¨å¤±æ•ˆ                   â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚  Badger:    æŒä¹…åŒ–é…ç½®ã€PinValueã€PinWrite       â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â–²
                              â”‚ gRPC (TLS)
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Edge ç«¯                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚  â”‚ gRPC Server  â”‚  â”‚ gRPC Client  â”‚                         â”‚
â”‚  â”‚ (EdgeService)â”‚  â”‚ (NodeUpService)                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚         â”‚                  â”‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              EdgeService (ä¸šåŠ¡é€»è¾‘)                    â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚ Node    â”‚ â”‚ Wire    â”‚ â”‚ Pin      â”‚ â”‚ Sync       â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ Service â”‚ â”‚ Service â”‚ â”‚ Service  â”‚ â”‚ Service    â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚               Storage (å†…å­˜ + Badger)                  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚  å†…å­˜:      å•ä¸ª node é…ç½®ï¼Œwires, pins ç´¢å¼•     â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚  Badger:    é…ç½®ã€PinValueã€PinWriteã€Sync æ—¶é—´  â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              è®¾å¤‡é©±åŠ¨å±‚ (ç”¨æˆ·å®ç°)                     â”‚  â”‚
â”‚  â”‚  - Modbus, GPIO, MQTT, HTTP, etc.                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Core ç«¯æ¶æ„

**èŒè´£**:
- ç®¡ç†å¤šä¸ª Edge èŠ‚ç‚¹
- æä¾› gRPC API ä¾› Edge è¿æ¥
- å­˜å‚¨æ‰€æœ‰èŠ‚ç‚¹çš„é…ç½®å’Œæ•°æ®
- æä¾›åŒ—å‘æ¥å£ï¼ˆAPI/Web UIï¼‰

**æœåŠ¡åˆ—è¡¨**:
- `CoreService`: Edge èŠ‚ç‚¹è¿æ¥çš„ gRPC æœåŠ¡
- `NodeService`: Node ç®¡ç† API (gRPC)
- `TcpNodeService`: TCP åè®®çš„èŠ‚ç‚¹è¿æ¥æœåŠ¡

### Edge ç«¯æ¶æ„

**èŒè´£**:
- ç®¡ç†æœ¬åœ°è®¾å¤‡
- é‡‡é›†è®¾å¤‡æ•°æ®
- ä¸ Core åŒæ­¥é…ç½®å’Œæ•°æ®
- æœ¬åœ°ç¼“å­˜å’Œç¦»çº¿èƒ½åŠ›

**æœåŠ¡åˆ—è¡¨**:
- `EdgeService`: æœ¬åœ° gRPC æœåŠ¡ (å¯é€‰)
- `NodeUpService`: è¿æ¥åˆ° Core çš„å®¢æˆ·ç«¯

## æ•°æ®æ¨¡å‹

### å±‚æ¬¡ç»“æ„

```
Node (èŠ‚ç‚¹)
 â””â”€â”€ Wire (é€šé“/ç«¯ç‚¹)
      â””â”€â”€ Pin (æ•°æ®ç‚¹)
           â”œâ”€â”€ PinValue (è¯»å–å€¼)
           â””â”€â”€ PinWrite (å†™å…¥å€¼)
```

### é…ç½®æ•°æ® vs å®æ—¶æ•°æ®

| ç±»å‹ | æ•°æ® | å­˜å‚¨ | ç‰¹ç‚¹ |
|------|------|------|------|
| é…ç½®æ•°æ® | Node, Wire, Pin | å†…å­˜ + NSON æŒä¹…åŒ– | ç›¸å¯¹é™æ€ï¼Œä¿®æ”¹å°‘ |
| å®æ—¶æ•°æ® | PinValue, PinWrite | Badger KV | é«˜é¢‘æ›´æ–°ï¼Œé”®å€¼å­˜å‚¨ |

### æ•°æ®æµå‘

```
Edge â†’ Core (ä¸ŠæŠ¥)
  - PinValue (è¯»å–å€¼)
  - èŠ‚ç‚¹é…ç½®æ›´æ–°

Core â†’ Edge (ä¸‹å‘)
  - PinWrite (å†™å…¥æŒ‡ä»¤)
  - é…ç½®æ›´æ–°
  - åŒæ­¥æ—¶é—´æˆ³

Edge â† Core (æ‹‰å–)
  - é…ç½®æ•°æ® (é¦–æ¬¡è¿æ¥æˆ–é…ç½®å˜æ›´)
  - PinWrite (å®šæœŸæ‹‰å–å¾…æ‰§è¡Œçš„å†™å…¥)
```

## å­˜å‚¨æ¶æ„

### Core ç«¯å­˜å‚¨

```go
type Storage struct {
    mu sync.RWMutex

    // ä¸»å­˜å‚¨
    nodes   map[string]*Node  // nodeID -> Node
    secrets map[string]string // nodeID -> secret

    // ç´¢å¼•/ç¼“å­˜ (æ‡’æ„å»º)
    index *index

    // Badger æŒä¹…åŒ–
    db *badger.DB
}
```

**å­˜å‚¨ç»“æ„**:
```
Badger Keys:
  node:{nodeID}       -> NSON(Node)
  secret:{nodeID}     -> string
  pv:{nodeID}:{pinID} -> NSON(PinValueEntry)
  pw:{nodeID}:{pinID} -> NSON(PinWriteEntry)
```

**ç‰¹ç‚¹**:
- æ‰€æœ‰é…ç½®åŠ è½½åˆ°å†…å­˜
- æ‡’ç´¢å¼•ï¼šé¦–æ¬¡æŸ¥è¯¢æ—¶æ„å»ºï¼Œæ•°æ®æ›´æ–°æ—¶å¤±æ•ˆ
- PinValue/PinWrite ä½¿ç”¨å‰ç¼€æ‰«æ

### Edge ç«¯å­˜å‚¨

```go
type Storage struct {
    mu sync.RWMutex

    // ä¸»å­˜å‚¨ (å•èŠ‚ç‚¹)
    node   *Node
    secret string

    // ç´¢å¼•/ç¼“å­˜
    index *index

    // Badger æŒä¹…åŒ–
    db *badger.DB
}
```

**å­˜å‚¨ç»“æ„**:
```
Badger Keys:
  node                -> NSON(Node)
  secret              -> string
  pv:{pinID}          -> NSON(PinValueEntry)
  pw:{pinID}          -> NSON(PinWriteEntry)
  sync:node           -> timestamp
  sync:pin_value      -> timestamp
  sync:pin_write      -> timestamp
  sync:node_ltr       -> timestamp (local to remote)
  sync:pv_ltr         -> timestamp
  sync:pw_rtl         -> timestamp (remote to local)
```

### NSON åºåˆ—åŒ–æ ¼å¼

**ä¼˜åŠ¿**:
- äºŒè¿›åˆ¶æ ¼å¼ï¼Œæ¯” JSON ç´§å‡‘ 30-50%
- æ”¯æŒå¤šç§æ•°æ®ç±»å‹
- è§£æé€Ÿåº¦å¿«
- æ”¯æŒæµå¼ç¼–è§£ç 

**ç¤ºä¾‹**:
```go
// åºåˆ—åŒ–
m, _ := nson.Marshal(node)
buf := new(bytes.Buffer)
nson.EncodeMap(m, buf)
data := buf.Bytes()

// ååºåˆ—åŒ–
buf := bytes.NewBuffer(data)
m, _ := nson.DecodeMap(buf)
var node Node
nson.Unmarshal(m, &node)
```

## é€šä¿¡åè®®

### gRPC æœåŠ¡å®šä¹‰

#### CoreService (Edge â†’ Core)

```protobuf
service SyncService {
  rpc Ping(Id) returns (MyBool);
  rpc GetUpdated(Id) returns (Updated);
}

service NodeService {
  rpc View(Id) returns (Node);
  rpc Name(Name) returns (Node);
}

service WireService {
  rpc View(Id) returns (Wire);
  // ...
}

service PinService {
  rpc View(Id) returns (Pin);
  // ...
}

service PinValueService {
  rpc GetValue(Id) returns (PinValue);
  rpc SetValue(PinValue) returns (MyBool);
  rpc GetValueByName(PinNameRequest) returns (PinNameValue);
}

service PinWriteService {
  rpc GetWrite(Id) returns (PinValue);
  rpc SetWrite(PinValue) returns (MyBool);
  rpc DeleteWrite(Id) returns (MyBool);
  rpc PullWrite(PinPullWriteRequest) returns (stream PinValue);
}
```

#### NodeService (å¤–éƒ¨ API)

```protobuf
service NodeService {
  rpc Create(Node) returns (Node);
  rpc Update(Node) returns (Node);
  rpc View(Id) returns (Node);
  rpc Delete(Id) returns (MyBool);
  rpc List(NodeListRequest) returns (NodeListResponse);
  rpc Link(Id) returns (stream NodeLinkResponse);
}
```

### è¿æ¥ç®¡ç†

**TLS æ”¯æŒ**:
- æ”¯æŒåŒå‘ TLS è®¤è¯
- å¯é…ç½® CAã€è¯ä¹¦ã€ç§é’¥
- å¯é€‰çš„ InsecureSkipVerify

**Keep-Alive**:
```go
kacp := keepalive.ClientParameters{
    Time:                120 * time.Second,
    Timeout:             10 * time.Second,
    PermitWithoutStream: true,
}
```

**å‹ç¼©**:
- gzip (gRPC å†…ç½®)
- zstd (è‡ªå®šä¹‰ï¼Œæ€§èƒ½æ›´å¥½)

## åŒæ­¥æœºåˆ¶

### åŒæ­¥ç±»å‹

1. **é…ç½®åŒæ­¥** (Node/Wire/Pin)
   - Edge â†’ Core: æ‰‹åŠ¨è§¦å‘ Push
   - Core â†’ Edge: æ£€æµ‹åˆ°å˜æ›´æ—¶é€šçŸ¥

2. **PinValue åŒæ­¥** (è¯»å–å€¼)
   - Edge â†’ Core: å®šæœŸä¸ŠæŠ¥æˆ–å®æ—¶ä¸ŠæŠ¥
   - å¢é‡åŒæ­¥: åªä¼ è¾“ Updated > LastSync çš„æ•°æ®

3. **PinWrite åŒæ­¥** (å†™å…¥æŒ‡ä»¤)
   - Core â†’ Edge: å®æ—¶æ¨é€æˆ–å®šæœŸæ‹‰å–
   - Edge æ‰§è¡Œååˆ é™¤

### åŒæ­¥æµç¨‹

#### é…ç½®åŒæ­¥ (Push)

```
Edge:
1. å¯¼å‡ºé…ç½®ä¸º NSON bytes
2. è°ƒç”¨ Core.Push(nodeID, nsonData)

Core:
1. è§£ç  NSON
2. éªŒè¯æ•°æ®
3. æ›´æ–°å†…å­˜å’Œ Badger
4. æ¸…é™¤æ—§ç´¢å¼•
```

#### PinValue åŒæ­¥

```
Edge:
1. è·å– LastSyncTime
2. æŸ¥è¯¢ Updated > LastSyncTime çš„ PinValue
3. æ‰¹é‡ä¸ŠæŠ¥åˆ° Core
4. æ›´æ–° LastSyncTime

Core:
1. æ¥æ”¶ PinValue åˆ—è¡¨
2. é€ä¸ªä¿å­˜åˆ° Badger
```

#### PinWrite åŒæ­¥ (Pull)

```
Edge:
1. è°ƒç”¨ Core.PullWrite(nodeID, after)
2. æ¥æ”¶ stream PinValue
3. é€ä¸ªæ‰§è¡Œå†™å…¥æ“ä½œ
4. æ‰§è¡ŒæˆåŠŸåè°ƒç”¨ Core.DeleteWrite(pinID)

Core:
1. æŸ¥è¯¢ nodeID çš„å¾…å†™å…¥ Pin
2. æµå¼è¿”å›
```

## è®¾å¤‡æŠ½è±¡

### Cluster ç³»ç»Ÿ

**è®¾è®¡æ€æƒ³**:
å€Ÿé‰´ Matter (æ™ºèƒ½å®¶å±…æ ‡å‡†) çš„ Cluster æ¦‚å¿µï¼Œå°†è®¾å¤‡åŠŸèƒ½æ ‡å‡†åŒ–ã€‚

**å·¥ä½œæµç¨‹**:

```
1. å®šä¹‰ Cluster
   - åŒ…å«ä¸€ç»„æ ‡å‡† Pin æ¨¡æ¿
   - ä¾‹å¦‚: OnOff, LevelControl, ColorControl

2. ä½¿ç”¨ WireBuilder åˆ›å»º Wire
   - æŒ‡å®šåŒ…å«çš„ Cluster åˆ—è¡¨
   - è‡ªåŠ¨ç”Ÿæˆå¯¹åº”çš„ Pin

3. éƒ¨ç½²åˆ°è®¾å¤‡
   - ç”¨æˆ·åªéœ€é…ç½® Pin çš„ Addr (åœ°å€)
   - Pin çš„åç§°ã€ç±»å‹ç­‰ç”± Cluster å®šä¹‰
```

### Builder æ¨¡å¼

```go
// åˆ›å»ºå¯è°ƒå…‰ç¯
result := NewWireBuilder("main_light").
    WithClusters("OnOff", "LevelControl").
    Build()

// result.Wire.Clusters = "OnOff,LevelControl"
// result.Pins = [
//   {Name: "onoff", Type: Bool, Rw: 1},
//   {Name: "level", Type: U32, Rw: 1},
//   {Name: "min_level", Type: U32, Rw: 0},
//   {Name: "max_level", Type: U32, Rw: 0},
// ]
```

### é¢„å®šä¹‰è®¾å¤‡æ¨¡æ¿

```go
BuildOnOffLightWire("light1")           // å¼€å…³ç¯
BuildDimmableLightWire("light2")        // å¯è°ƒå…‰ç¯
BuildColorLightWire("light3")           // RGB å½©ç¯
BuildTemperatureSensorWire("temp1")     // æ¸©åº¦ä¼ æ„Ÿå™¨
BuildTempHumiSensorWire("th1")          // æ¸©æ¹¿åº¦ä¼ æ„Ÿå™¨
```

### è‡ªå®šä¹‰ Cluster

```go
// å®šä¹‰è‡ªå®šä¹‰ Cluster
var MyCluster = Cluster{
    Name:        "MyDevice",
    Description: "è‡ªå®šä¹‰è®¾å¤‡",
    Pins: []PinTemplate{
        {Name: "value", Type: dt.TypeI32, Rw: 1},
        {Name: "status", Type: dt.TypeString, Rw: 0},
    },
}

// æ³¨å†Œ
RegisterCluster(&MyCluster)

// ä½¿ç”¨
result := NewWireBuilder("my_device").
    WithCluster("MyDevice").
    Build()
```

## æ€§èƒ½è€ƒè™‘

### æŸ¥è¯¢æ€§èƒ½

- å†…å­˜æŸ¥è¯¢: ~50-200 ns (çº³ç§’)
- SQL æŸ¥è¯¢: ~100-500 Î¼s (å¾®ç§’)
- **æ€§èƒ½æå‡**: 1000-10000 å€

### å¯åŠ¨é€Ÿåº¦

- åŠ è½½ 1000 ä¸ª Node (æ¯ä¸ª 100 Pin)
  - ååºåˆ—åŒ–: ~50-100 ms
  - æ‡’ç´¢å¼•: 0 ms (æŒ‰éœ€æ„å»º)
  - **æ€»è®¡**: ~50-100 ms

### å†…å­˜å ç”¨

- 1 ä¸ª Node (100 Pin):
  - åŸå§‹æ•°æ®: ~10 KB
  - å…¨éƒ¨ç´¢å¼•: ~16 KB (æœ€åæƒ…å†µ)
  - å®é™…: ~10-12 KB (æ‡’ç´¢å¼•)

- 1000 ä¸ª Node:
  - æ— ç´¢å¼•: ~10 MB
  - å…¨éƒ¨ç´¢å¼•: ~16 MB
  - å®é™…: ~10-12 MB

## å®‰å…¨æ€§

### è®¤è¯

- Node çº§åˆ«çš„ Secret
- JWT Token (å¯é€‰)
- TLS åŒå‘è®¤è¯

### æˆæƒ

- æŒ‰ Node éš”ç¦»
- API çº§åˆ«çš„æƒé™æ§åˆ¶ (å¾…å®ç°)

### æ•°æ®ä¿æŠ¤

- TLS ä¼ è¾“åŠ å¯†
- é…ç½®æ–‡ä»¶å¯ç­¾åéªŒè¯ (å¾…å®ç°)

## æ‰©å±•æ€§

### æ°´å¹³æ‰©å±•

- Core ç«¯å¯éƒ¨ç½²å¤šä¸ªå®ä¾‹ (éœ€è¦å…±äº«å­˜å‚¨)
- Edge ç«¯æ— é™æ‰©å±•
- é€šè¿‡ NodeService å®ç°è´Ÿè½½å‡è¡¡

### å‚ç›´æ‰©å±•

- å¢åŠ  Core ç«¯èµ„æº
- ä¼˜åŒ–ç´¢å¼•ç­–ç•¥
- ä½¿ç”¨æ›´å¿«çš„å­˜å‚¨

### æ’ä»¶åŒ– (æœªæ¥)

- è®¾å¤‡é©±åŠ¨æ’ä»¶
- æ•°æ®å¤„ç†ç®¡é“
- è‡ªå®šä¹‰åè®®æ”¯æŒ

## æ€»ç»“

Beacon æ¶æ„çš„æ ¸å¿ƒä¼˜åŠ¿:

1. **æ€§èƒ½**: å†…å­˜å­˜å‚¨ + æ‡’ç´¢å¼• + NSON åºåˆ—åŒ–
2. **ç®€æ´**: çº¯ Goï¼Œæ—  CGOï¼Œæ˜“éƒ¨ç½²
3. **çµæ´»**: Wire/Pin æ¨¡å‹é€‚é…å„ç§è®¾å¤‡
4. **æ ‡å‡†åŒ–**: Cluster ç³»ç»Ÿä¿ƒè¿›è®¾å¤‡å®šä¹‰ç»Ÿä¸€

é€‚ç”¨åœºæ™¯:

- å·¥ä¸šç‰©è”ç½‘æ•°æ®é‡‡é›†
- æ™ºèƒ½å®¶å±…ç³»ç»Ÿ
- è¾¹ç¼˜è®¡ç®—å¹³å°
- è®¾å¤‡ç®¡ç†ç³»ç»Ÿ

ä¸é€‚ç”¨åœºæ™¯:

- è¶…å¤§è§„æ¨¡ç³»ç»Ÿ (ç™¾ä¸‡çº§è®¾å¤‡ï¼Œå»ºè®®ä½¿ç”¨ä¸“ä¸š IoT å¹³å°)
- éœ€è¦å¤æ‚æŸ¥è¯¢çš„åœºæ™¯ (å»ºè®®é…åˆæ—¶åºæ•°æ®åº“)
- å¼ºä¸€è‡´æ€§è¦æ±‚çš„åœºæ™¯ (ç›®å‰æ˜¯æœ€ç»ˆä¸€è‡´æ€§)
